---
classes:
  - apache::vhosts
  - apache::mod::cgid
  - apache::mod::http2
  - apache::mod::status
  - letsencrypt
  - munin::master

packages:
  - libwww-perl # needed for apache munin modules

apache::vhosts::vhosts:
  pool.ntp.org:
    docroot: /var/www/html
    port: 80
    servername: pool.ntp.org
    serveraliases:
      - '*.pool.ntp.org'
      - '*.ntppool.org'
    redirect_source:
      - /
    redirect_dest:
      - https://www.ntppool.org/
    redirect_status:
      - permanent
  http:
    docroot: /var/www/html
    port: 80
    servername: '%{trusted.certname}'
  https:
    aliases:
      - alias: /munin/static/
        path: /var/cache/munin/www/static/
      - scriptalias: /munin-cgi/munin-cgi-graph
        path: /usr/lib/munin/cgi/munin-cgi-graph
      - scriptalias: /munin
        path: /usr/lib/munin/cgi/munin-cgi-html
    directories:
      - path: /var/cache/munin/www
      - path: /usr/lib/munin/cgi
        handler: cgi-script
    docroot: /var/www/html
    port: 443
    redirectmatch_regexp:
      - ^/munin$
    redirectmatch_dest:
      - /munin/
    redirectmatch_status:
      - permanent
    servername: '%{trusted.certname}'
    ssl: true
    ssl_cert: '/etc/letsencrypt/live/%{trusted.certname}/fullchain.pem'
    ssl_key: '/etc/letsencrypt/live/%{trusted.certname}/privkey.pem'

letsencrypt_certs:
  '%{trusted.certname}':
    plugin: webroot
    webroot_paths:
      - /var/www/html
    deploy_hook_commands:
      - systemctl reload apache2

munin_plugins:
  fw_conntrack:
    ensure: absent
  fw_conntrack_local:
    ensure: absent
  fw_forwarded_local:
    ensure: absent
  munin_update:
    ensure: link
  apache_accesses:
    ensure: link
  apache_processes:
    ensure: link
  apache_volume:
    ensure: link
  postfix_mailstats:
    ensure: link

profile::vms::kvm::linode::longview_api_key: >
  ENC[PKCS7,MIIBmQYJKoZIhvcNAQcDoIIBijCCAYYCAQAxggEhMIIBHQIBAD
  AFMAACAQEwDQYJKoZIhvcNAQEBBQAEggEAklt5Si/VGctLhON/CQGXoLNhG3
  2bFS/y4WBwtDg9prelMBBYIDYRaXfcfrq5XgVUwPWaLEJd9EMS0BoEZjbxft
  PsvohYk00UQL7ihnRIast5TPwqK2E8iY4JGy4BgAWy05avMewo/5A+ZZoFIL
  HF6xM/jL+wRdRaFu+ryZUCh2RzYOWnsLqRNbUhjv5YGwTQU9aWfA3fRA9eR+
  MSuo+6LRzPXlXKHBZithU5VXvJyCut9zAk1k9DVW5pj07s83DA9WnWlMmHA0
  dmW51zYrqNr0JGAuDTJjOL71J9RtdUhOAeHugy4GCm7pZYQXsQGqVPHey57P
  D6GacXXT2e59U3JTBcBgkqhkiG9w0BBwEwHQYJYIZIAWUDBAEqBBDhbdtam9
  +D+hRU+pAnxEKWgDB+G9lzS14kPJRspu/ot85uNypvu2zbTiKhlK4H9XOFpk
  uJUTFGZZn0K0NRS0WRFb4=]

rsyslog::config::actions:
  daemon:
    priority: 54
    type: omfile
    facility: daemon.*
    config:
      file: /var/log/daemon.log
  mail:
    type: omfile
    facility: mail.*
    config:
      file: /var/log/mail.log
  syslog:
    type: omfile
    facility: '*.*'
    config:
      file: /var/log/syslog

rsyslog::config::expression_filters:
  # filter edgerouter junk
  edgerouter:
    conditionals:
      if:
        expression: $msg contains '/usr/sbin/ubnt-check-unms.sh'
        tasks:
          - stop: true

rsyslog::config::inputs:
  imrelp:
    type: imrelp
    config:
      port: 20514
  imtcp:
    type: imtcp
    config:
      port: 514
      address: '%{facts.networking.ip6}'

rsyslog::config::modules:
  imklog: {}
  immark: {}
  imrelp: {}
  imtcp: {}
  imuxsock: {}
  omfile:
    type: builtin
    config:
      FileCreateMode: '0640'
      FileOwner: root
      FileGroup: adm
