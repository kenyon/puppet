---
# Configuration data for puppet.kenyonralph.com.

classes:
  - puppetdb
  - puppetdb::master::config
  - r10k::config
  - r10k::webhook
  - r10k::webhook::config
  - --mysite::ntp
  - mysite::vms::kvm
  - mysite::roles::puppetmaster
  - mysite::roles::puppetmaster::hiera_eyaml

packages:
  - ruby
  - augeas-tools

gems:
  - hiera-eyaml
  - r10k

mysite::roles::puppetmaster::puppetserver_gems:
  - hiera-eyaml
  - r10k

# As a Linode VM, don't need to set up serial console (can access
# console through Linode's web interface).
mysite::vms::kvm::enable_serial_console: no

r10k::config::remote: https://gitlab.com/kenyon/puppet.git
r10k::config::deploy_settings:
  purge_levels:
    - deployment
    - environment
    - puppetfile

# This webhook setup runs a web server on port 8088. Then I have
# configured a webhook in my puppet environments git repository for
# URL http://puppet.kenyonralph.com/payload that runs on push events:
# https://gitlab.com/kenyon/puppet/hooks
# So when I push to gitlab, 'r10k deploy environment --verbose --puppetfile' gets run.
r10k::webhook::use_mcollective: false
r10k::webhook::user: root
r10k::webhook::group: root
r10k::webhook::config::enable_ssl: false
r10k::webhook::config::use_mcollective: false
r10k::webhook::config::protected: false

# TODO: implement gitlab secret token support in https://github.com/voxpupuli/puppet-r10k/blob/master/templates/webhook.bin.erb
# Then have the eyaml-encrypted gitlab secret string here.
# r10k::webhook::config::github_secret:

# TODO: have puppetserver and webhook logs just go to standard output so that they are logged by systemd journal.
# https://puppet.com/docs/puppetserver/latest/config_logging_advanced.html
# http://logback.qos.ch/manual/appenders.html

...
