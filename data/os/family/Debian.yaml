---
# Debian-family-specific data.

classes:
  - mysite::debian
  - apt
  - unattended_upgrades

packages:
  - apt-file
  - apt-listbugs
  - apt-listchanges
  - apt-show-versions
  - apticron
  - aptitude
  - aptitude-doc-en
  - bash-completion
  - bash-doc
  - bind9-host
  - debian-goodies
  - dlocate
  - dnsutils
  - lsb-release
  - man-db
  - manpages-dev
  - molly-guard
  - moreutils
  - mtr-tiny
  - popularity-contest
  - rdnssd
  - vim

apt::include_defaults:
  deb: true
  src: true

apt::purge:
  sources.list: true
  sources.list.d: true
  preferences: true
  preferences.d: true

apt::sources:
  debian:
    location: https://deb.debian.org/debian
    release: "%{facts.os.distro.codename}"
    repos: main contrib non-free
  security:
    location: https://deb.debian.org/debian-security
    release: "%{facts.os.distro.codename}/updates"
    repos: main contrib non-free
  updates:
    location: https://deb.debian.org/debian
    release: "%{facts.os.distro.codename}-updates"
    repos: main contrib non-free
  backports:
    location: https://deb.debian.org/debian
    release: "%{facts.os.distro.codename}-backports"
    repos: main contrib non-free
  puppet:
    location: https://apt.puppetlabs.com
    release: "%{facts.os.distro.codename}"
    repos: puppet
    include:
      src: false

apt::confs:
  aptitude:
    content: |
      Aptitude {
          CmdLine {
              Always-Prompt "1";
              Show-Versions "1";
          };
          UI {
              Advance-On-Action "1";
          }
      };

augeases:
  apt_listchanges.conf:
    incl: /etc/apt/listchanges.conf
    lens: Puppet.lns
    changes:
      - set apt/confirm yes
      - set apt/which both
    require: Package[apt-listchanges]
  cron_defaults:
    context: /files/etc/default/cron
    changes:
      - set EXTRA_OPTS '"-L 15"' # that quoting weirdness https://www.redhat.com/archives/augeas-devel/2008-October/msg00023.html
    notify: Service[cron]

execs:
  update_resolvconf:
    command: /sbin/resolvconf -u
    refreshonly: true

files:
  # Assuming here that resolvconf is installed,
  # as it's a dependency of rdnssd.
  /etc/resolvconf/resolv.conf.d/tail:
    content: |
      options edns0 rotate
    notify: Exec[update_resolvconf]

services:
  cron:
    ensure: running
    enable: true

unattended_upgrades::extra_origins:
  - origin=Puppetlabs
  - origin=apt.postgresql.org
  - origin=Docker

# TODO: implement the new Unattended-Upgrade::MailReport setting in the module
unattended_upgrades::mail:
  # FIXME: after upgrading to unattended-upgrades 1.13 or newer (in Debian 11), remove
  # only_on_error so that we use the default "Unattended-Upgrade::MailReport: on-change"
  only_on_error: false
  to: root@localhost

# TODO: implement this and syslog_facility in the puppet module
unattended_upgrades::syslog_enable: true

# Local Variables:
# coding: utf-8
# End:
...
