---
# Common data.

lookup_options:
  apt::sources:
    merge: hash
  logrotate::rules:
    merge: hash
  profile::kenyon::dotfiles:
    merge: unique
  profile::kenyon::groups:
    merge: unique
  rhsm::enabled_repo_ids:
    merge: unique
  rsyslog::config::inputs:
    merge: hash
  rsyslog::config::modules:
    merge: hash

classes:
  - logrotate
  - munin::node
  - profile::kenyon
  - profile::mail
  - profile::multitail
  - profile::munin
  - profile::puppet
  - profile::ruby
  - profile::timesync
  - profile::zsh
  - rkhunter
  - rsyslog::config
  - ssh
  - sudo
  - timezone

# Packages I want installed.
packages:
  - aspell
  - bash-completion
  - colordiff
  - curl
  - emacs-nox
  - htop
  - iftop
  - keychain
  - lsof
  - mutt
  - nmap
  - pciutils
  - psmisc
  - pwgen
  - rsync
  - screen
  - smartmontools
  - subnetcalc
  - tmux
  - tree
  - unzip
  - w3m
  - wdiff
  - wget2
  - whois

# Packages I want to be absent.
# Can't really remove multiple packages though, even if I have listed
# all of their dependencies, because Puppet tries to remove each package
# individually:
# https://tickets.puppetlabs.com/browse/PUP-146
# https://tickets.puppetlabs.com/browse/PUP-1061
packages_absent:
  - ifupdown
  - isc-dhcp-client
  - nano
  - network-manager
  - openresolv
  - rdnssd
  - resolvconf

apache::default_ssl_vhost: false
apache::default_vhost: false
apache::mod::ssl::reload_on_change: true
apache::mod::ssl::ssl_sessiontickets: false
apache::mod::ssl::ssl_stapling: true
apache::mod::ssl::ssl_protocol:
  - all
  - -SSLv3
  - -TLSv1
  - -TLSv1.1
  - -TLSv1.2
apache::mpm_module: event
apache::protocols:
  - h2
  - h2c
  - http/1.1
apache::purge_vhost_dir: true

docker::ip_masq: false
docker::iptables: false
docker::log_driver: journald

profile::kenyon::dotfiles:
  - .aspell.en.prepl
  - .aspell.en.pws
  - .bash_aliases
  - .bash_profile
  - .bashrc
  - .bundle/config
  - .config/git/ignore
  - .emacs.d
  - .gitconfig
  - .inputrc
  - .profile
  - .screenrc
  - .signature
  - .tmux.conf
  - .vim
  - .vimrc
  - .Xresources
  - .zlogin
  - .zshenv
  - .zshrc

letsencrypt::email: kenyon@kenyonralph.com

munin::node::allow:
  - '::1'
  - 2600:3c01::f03c:92ff:fe8c:f7c9/128

munin_plugins:
  chrony_drift:
    ensure: present
    config:
      - user _chrony
      - env.driftfile /var/lib/chrony/drift
    source: https://raw.githubusercontent.com/munin-monitoring/contrib/02630d318ce12da72631ebacd478e3e214e73d42/plugins/chrony/chrony_drift
    checksum: sha256
    checksum_value: 2ea3c3ebf445b55c47d1530d8a2f1f94a36be8e0cb625d07f909fdf5a38837e7
  chrony_status:
    ensure: present
    config:
      - user _chrony
    source: https://raw.githubusercontent.com/kenyon/munin-monitoring-contrib/chrony_status_fix_graphs/plugins/chrony/chrony_status
    checksum: sha256
    checksum_value: 1ec209a86dce0382b4e60e1c5803035937b2d907a91950a756d526045d91019e
  http_loadtime:
    ensure: absent
  if_dummy0:
    ensure: absent
  if_err_dummy0:
    ensure: absent
  if_erspan0:
    ensure: absent
  if_err_erspan0:
    ensure: absent
  if_gretap0:
    ensure: absent
  if_err_gretap0:
    ensure: absent
  if_ip6gre0:
    ensure: absent
  if_err_ip6gre0:
    ensure: absent
  if_ip6tnl0:
    ensure: absent
  if_err_ip6tnl0:
    ensure: absent
  if_ip6_vti0:
    ensure: absent
  if_err_ip6_vti0:
    ensure: absent
  if_ip_vti0:
    ensure: absent
  if_err_ip_vti0:
    ensure: absent
  if_teql0:
    ensure: absent
  if_err_teql0:
    ensure: absent
  if_tunl0:
    ensure: absent
  if_err_tunl0:
    ensure: absent
  nfs4_client:
    ensure: absent
  nfs_client:
    ensure: absent
  nfsd:
    ensure: absent
  nfsd4:
    ensure: absent

nodejs::manage_package_repo: false
nodejs::manage_nodejs_package: false
nodejs::npm_package_ensure: present

postfix::inet_interfaces: loopback-only
# https://github.com/voxpupuli/puppet-postfix/pull/256
postfix::mydestination: $myhostname, localhost.$mydomain, localhost
postfix::relayhost: '[smtp.mail.me.com]:submission'
postfix::root_mail_recipient: kenyon@kenyonralph.com
postfix::satellite: true

# The sender addresses need to match my address for iCloud to accept the
# message. Something like kenyon@hostname.kenyonralph.com would be rejected.
postfix::maps:
  sender_rewrite:
    type: regexp
    content: |
      # Managed by Puppet
      /./ kenyon@kenyonralph.com
  smtp_header_checks:
    type: regexp
    content: |
      # Managed by Puppet
      /From:.*/ REPLACE From: kenyon@kenyonralph.com

profile::mail::postfix_sasl_passwd_content: |
  # Managed by Puppet
  %{lookup('postfix::relayhost')} kenyonralph:ENC[PKCS7,MIIBiQYJKoZIhvcNAQcDoIIBejCCAXYCAQAxggEhMIIBHQIBADAFMAACAQEwDQYJKoZIhvcNAQEBBQAEggEAOxKwg3+xtcxw06CJ5Agh/tTV2TWHT6cCWyqwMAHjckImX347aerRNIswK7xOa1EPU3EGQbO/MiLAP1Ol//d1SQKZ5VngoPkhYS0pUZyX5CqL4/S1N9LU5O580ZsBgb+gigYfh8zdQvaXXFbuo3TRMA3M1+wbIoC8qTA8Q9lYUJZS31aW2QVI6ngkQI4R5u3+7rCWOezRD2B3bKRp37X7G6GNSuFFdtcP3TUqqVwCw3e+IYFjR2EcxUf4+UVGjcwwihTinU8pgHQlEbBoGXRyID9CfhoRK1BeAQbEkhOnjhmigTthudTZrNt0ILxvxagJdI7tYTRj/mL1h1UUG7sjtjBMBgkqhkiG9w0BBwEwHQYJYIZIAWUDBAEqBBDau85T5DJWjYuIsx6u9XeVgCD12NQWe0zlOiYvJQSp30bBRn3g3zNedABwUk41QLdMoQ==]

postfix::configs:
  sender_canonical_maps:
    value: regexp:/etc/postfix/sender_rewrite
  smtp_header_checks:
    value: regexp:/etc/postfix/smtp_header_checks
  smtp_sasl_auth_enable:
    value: 'yes'
  smtp_tls_security_level:
    value: encrypt
  smtp_sasl_password_maps:
    value: hash:/etc/postfix/sasl/sasl_passwd
  smtp_sasl_tls_security_options:
    value: noanonymous

puppet_agent::package_version: auto
puppet_agent::collection: puppet
puppet_agent::config:
  - section: agent
    setting: splay
    value: 'true'
  - section: main
    setting: show_diff
    value: 'true'
  # https://puppet.com/docs/puppet/latest/report.html
  - section: server
    setting: reports
    value: log,store,puppetdb

rkhunter::allowhiddendir:
  - /etc/.git
  - /etc/.java
rkhunter::allowhiddenfile:
  - /etc/.etckeeper
  - /etc/.gitignore
rkhunter::allowipcproc:
  - /usr/bin/transmission-gtk
  - /usr/bin/virt-viewer
  - /usr/lib/firefox-esr/firefox-esr
  - /usr/lib/thunderbird/thunderbird-bin
  - /usr/sbin/apache2
rkhunter::allow_syslog_remote_logging: true
rkhunter::allow_ssh_prot_v1: '2'
rkhunter::allow_ssh_root_user: without-password
rkhunter::auto_x_detect: true
rkhunter::disable_tests: suspscan hidden_ports hidden_procs deleted_files packet_cap_apps apps properties
rkhunter::scriptwhitelist:
  - /bin/egrep
  - /bin/fgrep
  - /bin/which
  - /usr/bin/groups
  - /usr/bin/ldd
  - /usr/sbin/adduser
rkhunter::use_syslog: authpriv.warning

rsyslog::config::actions:
  forward_all:
    type: omrelp
    config:
      target: syslog.kenyonralph.com
      port: 20514

rsyslog::config::global_config:
  workDirectory:
    value: /var/spool/rsyslog

rsyslog::config::inputs:
  imuxsock_postfix:
    type: imuxsock
    config:
      # Originally this was done in /etc/rsyslog.d/postfix.conf:
      # Create an additional socket in postfix's chroot in order not to break
      # mail logging when rsyslog is restarted.  If the directory is missing,
      # rsyslog will silently skip creating the socket.
      Socket: /var/spool/postfix/dev/log
  munin-node:
    type: imfile
    config:
      file: /var/log/munin/munin-node.log
      tag: munin-node

rsyslog::config::modules:
  imfile: {}
  imklog: {}
  immark: {}
  imuxsock: {}
  omrelp: {}

rsyslog::feature_packages:
  - rsyslog-relp

smokeping::cgi_remark_top: SmokePing
smokeping::cgiurl: https://beta.kenyonralph.com/smokeping/smokeping.cgi
smokeping::contact: kenyon@kenyonralph.com
smokeping::default_probe: FPing6
smokeping::default_slaves:
  - hydrogen
smokeping::mailhost: localhost
smokeping::master_url: '%{alias("smokeping::cgiurl")}'
smokeping::owner: Kenyon Ralph
smokeping::path_piddir: /run/smokeping
smokeping::probes:
  - name: FPing
    binary: /usr/bin/fping
  - name: FPing6
    binary: /usr/bin/fping6
smokeping::targets:
  cloudflare_dns:
    host: one.one.one.one
  google_dns:
    host: dns.google
  linode_fremont:
    host: speedtest.fremont.linode.com
  spectrum_router:
    host: 2605:e000:40e:1a::1
    menu: Spectrum router
  spectrum_router_ipv4:
    host: 142.254.184.105
    menu: Spectrum router (IPv4)
    probe: FPing
  turing:
    host: turing.kenyonralph.com
    menu: turing
  turing_ipv4:
    host: 172.112.148.215
    menu: turing (IPv4)
    probe: FPing

ssh::client_options:
  Host *:
    ForwardAgent: yes
    ForwardX11: yes
    HashKnownHosts: no
    SendEnv: LANG LC_*
    StrictHostKeyChecking: accept-new
    VerifyHostKeyDNS: yes
    VisualHostKey: yes

ssh::server_options:
  AllowUsers: kenyon root
  PasswordAuthentication: no
  PermitRootLogin: without-password

# Additional entries for /etc/ssh/ssh_known_hosts for hosts not
# managed by puppet. Puppet-managed hosts are automatically added by
# the ssh module.
sshkeys:
  github.com:
    type: rsa
    key: AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==
  gitlab.com_rsa:
    type: rsa
    host_aliases: gitlab.com
    key: AAAAB3NzaC1yc2EAAAADAQABAAABAQCsj2bNKTBSpIYDEGk9KxsGh3mySTRgMtXL583qmBpzeQ+jqCMRgBqB98u3z++J1sKlXHWfM9dyhSevkMwSbhoR8XIq/U0tCNyokEi/ueaBMCvbcTHhO7FcwzY92WK4Yt0aGROY5qX2UKSeOvuP4D6TPqKF1onrSzH9bx9XUf2lEdWT/ia1NEKjunUqu1xOB/StKDHMoX4/OKyIzuS0q/T1zOATthvasJFoPrAjkohTyaDUz2LN5JoH839hViyEG82yB+MjcFV5MU3N1l1QL3cVUCh93xSaua1N85qivl+siMkPGbO5xR/En4iEY6K2XPASUEMaieWVNTRCtJ4S8H+9
  gitlab.com_ecdsa:
    type: ecdsa-sha2-nistp256
    host_aliases: gitlab.com
    key: AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBFSMqzJeV9rUzU4kWitGjeR4PWSa29SPqJ1fVkhtj3Hw9xjLVXVYrU9QlYWrOLXBpQ6KWjbjTDTdDkoohFzgbEY=
  gitlab.com_ed25519:
    type: ed25519
    host_aliases: gitlab.com
    key: AAAAC3NzaC1lZDI1NTE5AAAAIAfuCHKVTjquxvt6CM6tdG4SLp1Btn/nOeHHE5UOzRdf
  lish_fremont_rsa:
    type: rsa
    host_aliases: lish-fremont.linode.com
    key: AAAAB3NzaC1yc2EAAAADAQABAAABAQDb9siUm3yq4fVBYPtLh3Dg6VofNkgbRb9GaL+8q4uRRcQCOqVjGdB1ur6qZCQxknDKPwNvMuEYbWia/3svvbjCESkZAc8+DjLwe1gNE9fZ+x+KNOZTKmrQRh2+anYVi9oaHFwY/oNnfr9KeEKtRHd1lHTExO2mdyeAS1Ly+A5P6sjWyTLcOHQWGYEXxzwbsyjrmgjIHnmqRpKxlrBsdUokLKcFQvzuB3xiH2fvdXPlBJQcUb7g9tuITWzsjz6lozVPSQuvOJHthDZVIEfkT49F+Cpe9xviIAd/XqZG6xtosK/4Eu4Hof13jlT1uli9ZXnn0ROS6wKGsmLl3YWBG6DL
  lish_fremont_ecdsa:
    type: ecdsa-sha2-nistp256
    key: AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBEptV+WZ7MZXFnIEV9GXDEstViqlLKTSw9QY9qNE4CERwO537KAlYAaDoPut5YT4TpCZgqP32B1ECHc3LSD987o=
    host_aliases: lish-fremont.linode.com
  lish_fremont_ed25519:
    type: ed25519
    host_aliases: lish-fremont.linode.com
    key: AAAAC3NzaC1lZDI1NTE5AAAAIHAIXJ8SyXG2St6DgT6gQmkQSsX3pyp5FcQoSy/R2x9i
  turing_rsa:
    type: rsa
    host_aliases: &turing_aliases
      - turing
      - turing.kenyonralph.com
      - 10.0.0.1
    key: AAAAB3NzaC1yc2EAAAADAQABAAABAQDTgU2aUT/K2l1fOHScGz3f1llY1Whzt4DzmubwonyypxBS6PdXMaMs7rJ7hqwil50bN5IfluI766IFZfzz++Os4jGTDh7Ri4lr1pqiM2alieJfddLpH9JEgDfXGx7xTLV4+iKKagzDIdf/WHGwmfuK2j9pDBUuzz3igDkcJOOC91RgcUn/+v06c/21aS3n68psozTO2JkEwYlcQDozwW/eE3vwNNWdtMzd4Lyfvh6amWus6vt/hOh1TS5SM37NBRYS5jpcm39ZMhzc/+HPUt3uU0ht7FJFO0n8Dn0+QaeCR+c4y7jbGKXuGRgNPDNjGoV8Q+N0sw95ObZV2Qqeuood
  turing_ecdsa:
    type: ecdsa-sha2-nistp256
    host_aliases: *turing_aliases
    key: AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBAr4mZeYB3lqS3Xw9V8Lp+PNhELJLqUNb8M6+D++Qm8WUD+zxwuc2pgnjimr5wVSv5iS/w96O4PUFAaRcWBJTzI=
  turing_ed25519:
    type: ed25519
    host_aliases: *turing_aliases
    key: AAAAC3NzaC1lZDI1NTE5AAAAIIHgJAOsIt2Q50bojzd/B3OlV3LIkg3C+fp/WeEwJqLX

sudo::configs:
  insults:
    content: Defaults insults
  lessenv:
    content: Defaults env_keep += "LESS_TERMCAP_us LESS_TERMCAP_ue LESS_TERMCAP_so LESS_TERMCAP_se LESS_TERMCAP_me LESS_TERMCAP_md LESS_TERMCAP_mb"
  lessenv2:
    content: Defaults env_keep += "PAGER LESS MANWIDTH LESSOPEN BLOCKSIZE"

timezone::timezone: America/Los_Angeles
